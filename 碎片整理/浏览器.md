# 前端唯一真神

### 浏览器组成

1. shell 部分——用户能操作部分(壳)

2. 内核部分——用户看不到的部分

    - 渲染引擎（语法规则和渲染）

    - js 引擎

    > 2001 年发布 ie6，首次实现对 js 引擎的优化。2008 年 Google 发布最新浏览器 Chrome，它是采用优化后的 javascript 引擎，引擎代号 V8，因能把 js 代码直接转化为机械码来执行，进而以速度快而闻名。

    - 其他模块（如异步）

### 主流浏览器（独立内核，市场份额大于3%）

- IE ——> trident

- chrome ——> webkit/blink

- firefox ——> gecko

- opera ——> presto

- safari ——> webkit

### 浏览器输入url按下回车后发生了什么

#### 1. URL 解析

首先判断你输入的是一个合法的 URL 还是一个待搜索的关键词，并且根据你输入的内容进行自动完成、字符编码等操作。

（所谓的其它操作（不限于）：浏览器会通过历史记录、书签等地方智能匹配可能得到的url，然后给出提示，让用户可以补全url）

#### 2. DNS查询 

> 根据域名查找 IP 地址

##### DNS 查询过程

1. 浏览器缓存：浏览器会先检查缓存中是否存在我们输入的url，如果没有，则调用系统库函数进行查询。

2. 浏览器查看本地的 Hosts 文件，查看其中有没有和这个域名**对应**的规则，如果有的话就直接使用 Hosts 文件里面的 ip 地址，如果没有，浏览器会法送一个 DNS 请求，到本地的 DNS 服务器。

3. 本地的 DNS 服务器首先会查询自己的缓存记录，有就直接返回，这是一个递归的过程，没有就要向**根服务器**进行查询

4. 根DNS服务器**没有**记录具体的域名和IP地址的对应关系，而是告诉本地 DNS 服务器，你可以到域服务器上去继续查询，并给出域服务器的地址，这种过程是迭代的过程。

5. 本地 DNS 服务器继续向域服务器发出请求，得到一个域名和 IP 地址的对应关系，本地DNS 服务器将 IP 地址返回给用户电脑，同时将这个对应关系保存在缓存中，以备下次用户查询时快速返回结果。

##### DNS 查询的方式

1. 递归

当局部DNS服务器自己不能回答客户机的DNS查询时，它就需要向其他DNS服务器进行查询。此时有两种方式，如图所示的是递归方式。局部DNS服务器自己负责向其他DNS服务器进行查询，一般是先向该域名的根域服务器查询，再由根域名服务器一级级向下查询。最后得到的查询结果返回给局部DNS服务器，再由局部DNS服务器返回给客户端。

![](../Img/碎片/递归.jpg)

2. 迭代

当局部DNS服务器自己不能回答客户机的DNS查询时，也可以通过迭代查询的方式进行解析，如图所示。局部DNS服务器不是自己向其他DNS服务器进行查询，而是把能解析该域名的其他DNS服务器的IP地址返回给客户端DNS程序，客户端DNS程序再继续向这些DNS服务器进行查询，直到得到查询结果为止。也就是说，迭代解析只是帮你找到相关的服务器而已，而不会帮你去查。

![](../Img/碎片/迭代.jpg)

##### [前端 DNS 优化](https://zhuanlan.zhihu.com/p/65434058) 

##### [DNS 劫持](https://zhuanlan.zhihu.com/p/86538629)

#### 3.TCP（传输控制协议）连接

> 浏览器通过DNS解析得到了目标服务器的IP地址后，与服务器建立TCP连接

##### TCP 三次握手

1. 客户端发送数据包到服务器，等待服务端确认。

2. 服务端收到数据包，同意建立连接，并发送数据包返回给客户确认。

3. 客户端收到确认数据包，再向服务端发送一个数据包（确认已接受），客户端与服务端TCP连接建立完成，开始通信。

#### 4.（浏览器）发送 Http 请求

浏览器向主机发送 Http 请求（包含：要访问的URL、请求方法post/get……、浏览器/操作系统信息、编码……）。如果是第一此访问，会提示服务器简历用户缓存信息，如果不是可以利用 Cookies 对应键值找到相应缓存（缓存离存放着用户名、密码和一些用户设置项）。

#### 5.（服务主机）返回 Http 响应

服务器接受并处理完请求，返回 Http 相应（一个响应报文格式基本等同于请求报文，由相应行、响应头、空行、实体组成）。

#### 6.（浏览器）解析渲染页面

##### Html 解析，构建 DOM 树

1. 解码：传输回来的都是二进制字节数据，浏览器根据文件指定编码（例：UTF-8）转换成字符串，即 Html 代码。

2. 预解析：识别一些资源请求（例：img 标签的 src），添加到请求列队中

3. 词法解析，构建 DOM 树（并行操作，解析到一个标签，就会创建一个 DOM 节点） 

> 解析完成后，浏览器会通过 `DOMContentLoaded` 事件，通知 DOM 解析完成。

#####  CSS 解析，构建渲染树

CSS 解析器会根据语法解析规范解析CSS 文件，并进行标记；再通过 CSS 匹配规则，构建出渲染树。

##### 布局渲染（过程比较复杂）

浏览器开始布局渲染树，并将其绘制到屏幕上。

1. 回流（reflow）：DOM 节点中各个元素都是以盒子模型的形式存在，这就需要浏览器去计算其位置和大小，这个过程称为回流。

2. 重绘（repain）：当盒子模型的位置、大小、颜色等属性确定下来之后，浏览器开始绘制内容，这个过程称为重绘。

> 回流必定触发重绘，重绘不一定触发回流。重绘的开销较小，回流的代价较高。

#### 7. 断开连接（TCP 四次挥手）

> 客户端和服务端均可主动发起挥手

（假设客户端发起）

1. 客户端发送一个 FIN 报文，报文中指定一个序列号，等待服务端确认。

2. 服务端 接收 FIN 之后，发送 ACK 报文，且把客户端的序列号值 +1 作为 ACK 报文序列号，表明已经收到客户端报文。

3. 服务端发送 FIN 报文……

4. 客户端接收 FIN ……

### Cookies